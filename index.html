<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Estate Market Explorer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #080b12; --surface: #0f1117; --surface2: #1a1e2e; --border: #2a2d3a;
    --muted: #334155; --subtle: #475569; --text: #e2e8f0; --text-dim: #94a3b8;
    --accent: #38bdf8; --accent2: #818cf8; --danger: #f87171;
  }
  body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; min-height: 100vh; padding: 32px 24px; }
  ::-webkit-scrollbar { width: 5px; background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .header { margin-bottom: 28px; }
  .header h1 {
    font-family: 'Syne', sans-serif; font-size: clamp(22px,4vw,34px); font-weight: 800;
    letter-spacing: -0.02em; background: linear-gradient(90deg,var(--accent),var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 6px;
  }
  .header p { color: var(--subtle); font-size: 11px; letter-spacing: 0.12em; }

  /* State picker */
  .state-screen { max-width: 700px; margin: 0 auto; }
  .state-screen h2 { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
  .state-screen p { font-size: 11px; color: var(--subtle); letter-spacing: 0.08em; margin-bottom: 24px; }
  .state-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(58px, 1fr));
    gap: 8px;
  }
  .state-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 6px;
    font-family: inherit;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    letter-spacing: 0.05em;
  }
  .state-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(56,189,248,0.06); }
  .state-btn.active { border-color: var(--accent); color: #080b12; background: var(--accent); }

  /* Loading */
  .progress-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 32px 24px; text-align: center; max-width: 480px; margin: 0 auto; }
  .progress-label { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; }
  .progress-bar-bg { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: linear-gradient(90deg,var(--accent),var(--accent2)); border-radius: 2px; transition: width 0.3s; width: 0%; }

  /* Mode toggle */
  .top-bar { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
  .mode-toggle { display: inline-flex; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 3px; gap: 2px; }
  .mode-btn { padding: 7px 20px; font-family: inherit; font-size: 11px; letter-spacing: 0.1em; border: none; border-radius: 6px; cursor: pointer; transition: all 0.15s; background: transparent; color: var(--subtle); }
  .mode-btn.active { background: var(--accent); color: #080b12; font-weight: 500; }
  .change-state-btn {
    background: transparent; border: 1px solid var(--border); border-radius: 6px;
    color: var(--subtle); font-family: inherit; font-size: 11px; padding: 7px 14px;
    cursor: pointer; letter-spacing: 0.08em; transition: all 0.15s;
  }
  .change-state-btn:hover { border-color: var(--accent); color: var(--accent); }
  .state-badge {
    font-size: 11px; color: var(--accent2); letter-spacing: 0.1em;
    background: rgba(129,140,248,0.1); border: 1px solid rgba(129,140,248,0.2);
    border-radius: 6px; padding: 7px 12px;
  }

  /* Controls */
  .controls { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; align-items: flex-start; }
  .control-group { flex: 1 1 240px; max-width: 380px; }
  .control-label { font-size: 10px; color: var(--subtle); letter-spacing: 0.12em; margin-bottom: 6px; }
  .select-box { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; cursor: pointer; font-size: 13px; color: var(--text); display: flex; justify-content: space-between; align-items: center; user-select: none; transition: border-color 0.15s; }
  .select-box:hover { border-color: var(--accent); }
  .select-box.placeholder { color: var(--subtle); }
  .select-arrow { color: var(--subtle); font-size: 10px; flex-shrink: 0; margin-left: 8px; }
  .select-wrapper { position: relative; }
  .dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; z-index: 1000; max-height: 320px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 12px 40px rgba(0,0,0,0.6); }
  .dropdown-search { background: var(--surface2); border: none; border-bottom: 1px solid var(--border); padding: 10px 14px; color: var(--text); font-size: 12px; font-family: inherit; outline: none; }
  .dropdown-list { overflow-y: auto; flex: 1; }
  .dropdown-item { padding: 9px 14px; cursor: pointer; font-size: 12px; color: var(--text-dim); transition: background 0.1s,color 0.1s; display: flex; justify-content: space-between; align-items: center; }
  .dropdown-item:hover { background: var(--surface2); color: var(--accent); }
  .dropdown-item.active { background: var(--surface2); color: var(--accent); }
  .dropdown-item .sub { color: var(--muted); font-size: 10px; }
  .dropdown-empty { padding: 14px; color: var(--muted); font-size: 12px; text-align: center; }

  /* Content */
  .chart-card { background: #0a0d16; border: 1px solid var(--surface2); border-radius: 12px; padding: 24px 20px 20px; }
  .chart-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .chart-subtitle { font-size: 11px; color: var(--subtle); margin-bottom: 20px; }
  .chart-wrap { position: relative; height: 300px; }
  .stats-row { display: flex; gap: 28px; flex-wrap: wrap; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--surface2); }
  .stat-label { font-size: 9px; color: var(--muted); letter-spacing: 0.12em; margin-bottom: 3px; }
  .stat-value { font-size: 15px; color: var(--accent); font-weight: 500; }

  .empty-state { border: 1px dashed var(--surface2); border-radius: 12px; padding: 80px 24px; text-align: center; color: var(--muted); font-size: 13px; }

  .export-bar { display: flex; gap: 10px; margin-top: 16px; }
  .export-btn {
    background: var(--surface); border: 1px solid var(--border); border-radius: 7px;
    padding: 8px 16px; font-family: inherit; font-size: 11px; letter-spacing: 0.08em;
    color: var(--text-dim); cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 7px;
  }
  .export-btn:hover { border-color: var(--accent); color: var(--accent); }
  .export-btn svg { flex-shrink: 0; }

  /* Summary card (hidden, used for JPEG render) */
  #summary-card {
    position: fixed; left: -9999px; top: 0;
    width: 900px; background: #080b12; padding: 32px;
    font-family: 'DM Mono', monospace; color: #e2e8f0;
  }
  .sc-header { margin-bottom: 18px; border-bottom: 1px solid #2a2d3a; padding-bottom: 14px; }
  .sc-title { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800;
    background: linear-gradient(90deg,#38bdf8,#818cf8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 4px; }
  .sc-sub { font-size: 11px; color: #475569; letter-spacing: 0.1em; }
  .sc-date { font-size: 11px; color: #475569; margin-top: 4px; }
  .sc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .sc-cell { background: #0f1117; border: 1px solid #1a1e2e; border-radius: 10px; padding: 12px 16px; }
  .sc-cell-label { font-size: 9px; color: #e2e8f0; letter-spacing: 0.1em; margin-bottom: 5px; text-transform: uppercase; }
  .sc-cell-value { font-size: 17px; color: #38bdf8; font-weight: 500; }
  .sc-footer { margin-top: 24px; padding-top: 16px; border-top: 1px solid #1a1e2e;
    font-size: 10px; color: #334155; letter-spacing: 0.08em; }

  #last-updated { font-size: 10px; color: var(--muted); margin-top: 20px; letter-spacing: 0.08em; }

  /* Screens */
  #state-screen { display: block; }
  #loading-screen { display: none; }
  #app-screen { display: none; }
</style>
</head>
<body>

<div class="header">
  <h1>Real Estate Market Explorer</h1>
  <p>REALTOR.COM INVENTORY DATA</p>
</div>

<!-- State picker -->
<div id="state-screen">
  <div class="state-screen">
    <h2>Select a State</h2>
    <p>CHOOSE A STATE TO LOAD COUNTY AND ZIP CODE DATA</p>
    <div class="state-grid" id="state-grid"></div>
  </div>
</div>

<!-- Loading -->
<div id="loading-screen">
  <div class="progress-wrap">
    <div class="progress-label" id="loading-label">Loading...</div>
    <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-bar"></div></div>
    <div id="loading-sub" style="font-size:11px;color:var(--muted);margin-top:12px;"></div>
  </div>
</div>

<!-- App -->
<div id="app-screen">
  <div class="top-bar">
    <div class="mode-toggle">
      <button class="mode-btn active" id="btn-county" onclick="switchMode('county')">COUNTY</button>
      <button class="mode-btn" id="btn-zip" onclick="switchMode('zip')">ZIP CODE</button>
    </div>
    <div class="state-badge" id="state-badge">TX</div>
    <button class="change-state-btn" onclick="changeState()">&#8592; Change State</button>
  </div>

  <div class="controls">
    <div class="control-group">
      <div class="control-label" id="geo-label">COUNTY</div>
      <div class="select-wrapper" id="geo-wrapper">
        <div class="select-box placeholder" id="geo-box" onclick="toggleDropdown('geo')">
          <span id="geo-selected-label">Select a county...</span>
          <span class="select-arrow">&#9660;</span>
        </div>
        <div class="dropdown" id="geo-dropdown" style="display:none">
          <input class="dropdown-search" id="geo-search" placeholder="Search..." oninput="filterGeoList()" autocomplete="off">
          <div class="dropdown-list" id="geo-list"></div>
        </div>
      </div>
    </div>

    <div class="control-group">
      <div class="control-label">METRIC</div>
      <div class="select-wrapper" id="metric-wrapper">
        <div class="select-box placeholder" id="metric-box" onclick="toggleDropdown('metric')">
          <span id="metric-label" style="color:var(--subtle)">Select a metric...</span>
          <span class="select-arrow">&#9660;</span>
        </div>
        <div class="dropdown" id="metric-dropdown" style="display:none">
          <div class="dropdown-list" id="metric-list"></div>
        </div>
      </div>
    </div>

    <div class="control-group" id="export-bar" style="display:none;flex:0 0 auto;align-self:flex-end;">
      <div class="control-label">OVERVIEW REPORT</div>
      <div style="display:flex;gap:8px;">
        <button class="export-btn" onclick="exportCSV()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          CSV
        </button>
        <button class="export-btn" onclick="exportJPEG()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          JPEG
        </button>
      </div>
    </div>
  </div>

  <div id="main-layout" style="display:none">
    <div id="chart-panel">
      <div class="empty-state" style="height:300px;display:flex;align-items:center;justify-content:center;">Select a location to begin exploring</div>
    </div>
  </div>
  <div id="empty-state-msg">
    <div class="empty-state">Select a location to begin exploring</div>
  </div>
  <div id="last-updated"></div>
</div>

<!-- Summary card for JPEG export (off-screen) -->
<div id="summary-card"></div>

<script>
const STATES = [
  'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','ID','IL','IN',
  'IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH',
  'NJ','NM','NY','NC','ND','OH','OK','OR','PA','PR','RI','SC','SD','TN','TX',
  'UT','VT','VA','WA','WV','WI','WY'
];

const STATE_NAMES = {
  AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',CO:'Colorado',
  CT:'Connecticut',DE:'Delaware',DC:'District of Columbia',FL:'Florida',GA:'Georgia',
  HI:'Hawaii',ID:'Idaho',IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',
  LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',MI:'Michigan',MN:'Minnesota',
  MS:'Mississippi',MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',
  NJ:'New Jersey',NM:'New Mexico',NY:'New York',NC:'North Carolina',ND:'North Dakota',
  OH:'Ohio',OK:'Oklahoma',OR:'Oregon',PA:'Pennsylvania',PR:'Puerto Rico',RI:'Rhode Island',
  SC:'South Carolina',SD:'South Dakota',TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',
  VA:'Virginia',WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming'
};

const METRICS = [
  { key:"active_listing_count", label:"Active Listing Count", format:"number" },
  { key:"active_listing_count_mm", label:"Active Listings (M/M %)", format:"percent" },
  { key:"active_listing_count_yy", label:"Active Listings (Y/Y %)", format:"percent" },
  { key:"average_listing_price", label:"Average Listing Price", format:"currency" },
  { key:"average_listing_price_mm", label:"Average Listing Price (M/M %)", format:"percent" },
  { key:"average_listing_price_yy", label:"Average Listing Price (Y/Y %)", format:"percent" },
  { key:"median_days_on_market_mm", label:"Days on Market (M/M %)", format:"percent" },
  { key:"median_days_on_market", label:"Days on Market (Median)", format:"number" },
  { key:"median_days_on_market_yy", label:"Days on Market (Y/Y %)", format:"percent" },
  { key:"median_listing_price", label:"Median Listing Price", format:"currency" },
  { key:"median_listing_price_mm", label:"Median Listing Price (M/M %)", format:"percent" },
  { key:"median_listing_price_yy", label:"Median Listing Price (Y/Y %)", format:"percent" },
  { key:"median_listing_price_per_square_foot", label:"Median Price Per Sq Ft", format:"currency" },
  { key:"median_listing_price_per_square_foot_mm", label:"Median Price Per Sq Ft (M/M %)", format:"percent" },
  { key:"median_listing_price_per_square_foot_yy", label:"Median Price Per Sq Ft (Y/Y %)", format:"percent" },
  { key:"median_square_feet", label:"Median Square Feet", format:"number" },
  { key:"median_square_feet_mm", label:"Median Square Feet (M/M %)", format:"percent" },
  { key:"median_square_feet_yy", label:"Median Square Feet (Y/Y %)", format:"percent" },
  { key:"new_listing_count", label:"New Listing Count", format:"number" },
  { key:"new_listing_count_mm", label:"New Listings (M/M %)", format:"percent" },
  { key:"new_listing_count_yy", label:"New Listings (Y/Y %)", format:"percent" },
  { key:"pending_listing_count", label:"Pending Listing Count", format:"number" },
  { key:"pending_listing_count_mm", label:"Pending Listings (M/M %)", format:"percent" },
  { key:"pending_listing_count_yy", label:"Pending Listings (Y/Y %)", format:"percent" },
  { key:"pending_ratio", label:"Pending Ratio", format:"decimal" },
  { key:"pending_ratio_mm", label:"Pending Ratio (M/M %)", format:"percent" },
  { key:"pending_ratio_yy", label:"Pending Ratio (Y/Y %)", format:"percent" },
  { key:"price_increased_count", label:"Price Increased Count", format:"number" },
  { key:"price_increased_share", label:"Price Increased Share", format:"percent" },
  { key:"price_reduced_count", label:"Price Reduced Count", format:"number" },
  { key:"price_reduced_share", label:"Price Reduced Share", format:"percent" },
  { key:"total_listing_count", label:"Total Listing Count", format:"number" },
  { key:"total_listing_count_mm", label:"Total Listings (M/M %)", format:"percent" },
  { key:"total_listing_count_yy", label:"Total Listings (Y/Y %)", format:"percent" },
];

const FIPS_TO_STATE = {
  '01':'AL','02':'AK','04':'AZ','05':'AR','06':'CA','08':'CO','09':'CT','10':'DE',
  '11':'DC','12':'FL','13':'GA','15':'HI','16':'ID','17':'IL','18':'IN','19':'IA',
  '20':'KS','21':'KY','22':'LA','23':'ME','24':'MD','25':'MA','26':'MI','27':'MN',
  '28':'MS','29':'MO','30':'MT','31':'NE','32':'NV','33':'NH','34':'NJ','35':'NM',
  '36':'NY','37':'NC','38':'ND','39':'OH','40':'OK','41':'OR','42':'PA','44':'RI',
  '45':'SC','46':'SD','47':'TN','48':'TX','49':'UT','50':'VT','51':'VA','53':'WA',
  '54':'WV','55':'WI','56':'WY','72':'PR'
};

// ── App state ──────────────────────────────────────────────────────────────
let selectedState = null;
let mode = 'county';
let countyMap = new Map(), countyDataMap = new Map();
let zipMap = new Map(), zipDataMap = new Map();
let countyLoaded = false, zipLoaded = false;
let selectedGeoKey = null;
let selectedMetric = null;
let chartInstance = null;
let filteredGeoList = [];

// ── Helpers ────────────────────────────────────────────────────────────────
function titleCase(str) {
  const small = new Set(['a','an','the','and','but','or','for','nor','on','at','to','by','in','of','up','as','is']);
  return str.toLowerCase().split(/\s+/).map((w,i) =>
    (i===0||!small.has(w)) ? w.charAt(0).toUpperCase()+w.slice(1) : w
  ).join(' ');
}

function formatCountyName(rawName, fips) {
  const stateFips = String(fips).padStart(5,'0').slice(0,2);
  const stateAbbr = FIPS_TO_STATE[stateFips] || '';
  let name = rawName.replace(/,?\s+[a-zA-Z]{2}$/,'').trim();
  name = name.replace(/\s+County$/i,'').replace(/\s+Parish$/i,'').replace(/\s+Borough$/i,'')
             .replace(/\s+Census Area$/i,'').replace(/\s+Municipality$/i,'')
             .replace(/\s+City and Borough$/i,'').replace(/\s+Municipio$/i,'').trim();
  return stateAbbr ? titleCase(name)+', '+stateAbbr : titleCase(name);
}

function formatZipName(zipName, postalCode) {
  if (!zipName) return String(postalCode);
  const parts = String(zipName).split(',');
  const city = titleCase(parts[0].trim());
  const state = parts[1] ? parts[1].trim().toUpperCase() : '';
  return state ? city+', '+state+' ('+postalCode+')' : city+' ('+postalCode+')';
}


function formatValue(val, fmt) {
  if (val===null||val===undefined||val===''||isNaN(+val)) return 'N/A';
  const n = +val;
  if (fmt==='currency') return '$'+n.toLocaleString(undefined,{maximumFractionDigits:0});
  if (fmt==='percent') return (n*100).toFixed(1)+'%';
  if (fmt==='decimal') return n.toFixed(3);
  return n.toLocaleString(undefined,{maximumFractionDigits:1});
}
function formatDate(d) { const s=String(d).trim(); return s.slice(0,4)+'-'+s.slice(4,6); }

// ── State grid ─────────────────────────────────────────────────────────────
function buildStateGrid() {
  const grid = document.getElementById('state-grid');
  STATES.forEach(st => {
    const btn = document.createElement('button');
    btn.className = 'state-btn';
    btn.title = STATE_NAMES[st] || st;
    btn.textContent = st;
    btn.onclick = () => selectState(st);
    grid.appendChild(btn);
  });
}

function selectState(st) {
  selectedState = st;
  document.querySelectorAll('.state-btn').forEach(b => b.classList.toggle('active', b.textContent === st));
  // Reset everything
  countyMap.clear(); countyDataMap.clear();
  zipMap.clear(); zipDataMap.clear();
  countyLoaded = false; zipLoaded = false;
  selectedGeoKey = null;
  mode = 'county';
  // Update badge
  document.getElementById('state-badge').textContent = st + ' — ' + (STATE_NAMES[st]||st);
  document.getElementById('btn-county').classList.add('active');
  document.getElementById('btn-zip').classList.remove('active');
  document.getElementById('geo-label').textContent = 'COUNTY';
  document.getElementById('geo-selected-label').textContent = 'Select a county...';
  document.getElementById('geo-box').classList.add('placeholder');
  document.getElementById('main-layout').style.display = 'none';
  document.getElementById('empty-state-msg').style.display = '';
  document.getElementById('export-bar').style.display = 'none';
  loadDataset('county');
}

function changeState() {
  document.getElementById('state-screen').style.display = 'block';
  document.getElementById('app-screen').style.display = 'none';
  document.getElementById('loading-screen').style.display = 'none';
}

// ── Loading ────────────────────────────────────────────────────────────────
function loadDataset(which) {
  if (which==='county' && countyLoaded) { showApp(); return; }
  if (which==='zip' && zipLoaded) { showApp(); return; }

  document.getElementById('state-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'none';
  document.getElementById('loading-screen').style.display = 'block';

  const label = document.getElementById('loading-label');
  const bar = document.getElementById('progress-bar');
  bar.style.width = '0%';
  bar.style.background = 'linear-gradient(90deg,var(--accent),var(--accent2))';
  document.getElementById('loading-sub').textContent = '';
  label.textContent = 'Loading ' + selectedState + ' ' + which + ' data...';

  const path = 'data/' + which + '/' + selectedState + '.csv';
  let rowCount = 0;

  fetch(path)
    .then(res => {
      if (!res.ok) throw new Error('HTTP ' + res.status + ' — data not available for ' + selectedState);
      return res.text();
    })
    .then(text => {
      label.textContent = 'Parsing...';
      bar.style.width = '60%';
      Papa.parse(text, {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        chunk(results) {
          rowCount += results.data.length;
          results.data.forEach(row => ingestRow(row, which));
        },
        complete() {
          bar.style.width = '100%';
          (which==='county'?countyDataMap:zipDataMap).forEach(rows=>rows.sort((a,b)=>+a.month_date_yyyymm - +b.month_date_yyyymm));
          if (which==='county') countyLoaded=true; else zipLoaded=true;
          console.log('Loaded ' + (which==='county'?countyMap.size:zipMap.size) + ' ' + which + ' entries for ' + selectedState);
          setTimeout(showApp, 150);
        },
        error(err) { showError(err.message); }
      });
    })
    .catch(err => showError(err.message));
}

function showError(msg) {
  document.getElementById('loading-label').textContent = 'Error loading data';
  document.getElementById('progress-bar').style.background = '#f87171';
  document.getElementById('loading-sub').innerHTML =
    '<div style="color:var(--danger);margin-bottom:10px;">'+msg+'</div>' +
    '<button onclick="changeState()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:8px 16px;cursor:pointer;font-size:12px;color:var(--accent);font-family:inherit;">&#8592; Back to State Picker</button>';
}

function showApp() {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('state-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'block';
  document.getElementById('last-updated').textContent = 'DATA LOADED ' + new Date().toUTCString();
  buildMetricList();
  refreshGeoList();
}

// ── Ingest ─────────────────────────────────────────────────────────────────
function ingestRow(row, which) {
  if (which==='county') {
    if (!row.county_fips||!row.county_name) return;
    const fips = String(row.county_fips);
    if (!countyMap.has(fips)) countyMap.set(fips, formatCountyName(row.county_name, row.county_fips));
    if (!countyDataMap.has(fips)) countyDataMap.set(fips,[]);
    countyDataMap.get(fips).push(row);
  } else {
    if (!row.postal_code) return;
    const zip = String(row.postal_code).padStart(5,'0');
    if (!zipMap.has(zip)) {
      zipMap.set(zip, formatZipName(row.zip_name, zip));
    }
    if (!zipDataMap.has(zip)) zipDataMap.set(zip,[]);
    zipDataMap.get(zip).push(row);
  }
}

// ── Mode switch ────────────────────────────────────────────────────────────
function switchMode(newMode) {
  if (newMode===mode && (newMode==='county'?countyLoaded:zipLoaded)) return;
  mode = newMode;
  selectedGeoKey = null;
  document.getElementById('btn-county').classList.toggle('active', mode==='county');
  document.getElementById('btn-zip').classList.toggle('active', mode==='zip');
  document.getElementById('geo-label').textContent = mode==='county' ? 'COUNTY' : 'ZIP CODE';
  document.getElementById('geo-selected-label').textContent = mode==='county' ? 'Select a county...' : 'Select a zip code...';
  document.getElementById('geo-box').classList.add('placeholder');
  document.getElementById('main-layout').style.display = 'none';
  document.getElementById('empty-state-msg').style.display = '';
  if (mode==='zip' && !zipLoaded) loadDataset('zip');
  else refreshGeoList();
}

// ── Geo list ───────────────────────────────────────────────────────────────
function curMap() { return mode==='county' ? countyMap : zipMap; }
function curData() { return mode==='county' ? countyDataMap : zipDataMap; }

function refreshGeoList() {
  let entries = Array.from(curMap().entries()).map(([key,name])=>({key,name}));
  filteredGeoList = entries.sort((a,b)=>a.name.localeCompare(b.name));
  renderGeoList(filteredGeoList);
}

function renderGeoList(list) {
  const c = document.getElementById('geo-list'); c.innerHTML = '';
  const shown = list.slice(0,150);
  if (!shown.length) { c.innerHTML = '<div class="dropdown-empty">No results</div>'; return; }
  shown.forEach(item => {
    const div = document.createElement('div');
    div.className = 'dropdown-item'+(item.key===selectedGeoKey?' active':'');
    div.innerHTML = '<span>'+item.name+'</span><span class="sub">'+item.key+'</span>';
    div.onclick = () => selectGeo(item.key, item.name);
    c.appendChild(div);
  });
  if (list.length>150) c.innerHTML += '<div class="dropdown-empty">+'+(list.length-150)+' more — type to filter</div>';
}

function filterGeoList() {
  const q = document.getElementById('geo-search').value.toLowerCase();
  const all = Array.from(curMap().entries()).map(([key,name])=>({key,name})).sort((a,b)=>a.name.localeCompare(b.name));
  filteredGeoList = q ? all.filter(c=>c.name.toLowerCase().includes(q)||c.key.includes(q)) : all;
  renderGeoList(filteredGeoList);
}

function selectGeo(key, name) {
  selectedGeoKey = key;
  document.getElementById('geo-box').classList.remove('placeholder');
  document.getElementById('geo-selected-label').textContent = name;
  document.getElementById('geo-dropdown').style.display = 'none';
  document.getElementById('export-bar').style.display = 'flex';
  renderGeoList(filteredGeoList);
  renderContent();
}

// ── Location filter ────────────────────────────────────────────────────────



// ── Dropdowns ──────────────────────────────────────────────────────────────
function toggleDropdown(which) {
  const dd = document.getElementById(which+'-dropdown');
  ['geo','metric'].forEach(w => {
    if (w!==which) document.getElementById(w+'-dropdown').style.display = 'none';
  });
  const open = dd.style.display !== 'none';
  dd.style.display = open ? 'none' : 'flex';
  if (!open && which==='geo') {
    document.getElementById('geo-search').value = '';
    filterGeoList();
    setTimeout(() => document.getElementById('geo-search').focus(), 50);
  }
}
document.addEventListener('click', e => {
  ['geo','metric'].forEach(w => {
    const wr = document.getElementById(w+'-wrapper');
    if (wr && !wr.contains(e.target)) document.getElementById(w+'-dropdown').style.display = 'none';
  });
});

// ── Metric list ────────────────────────────────────────────────────────────
function buildMetricList() {
  const list = document.getElementById('metric-list');
  if (list.children.length) return;
  METRICS.forEach(m => {
    const div = document.createElement('div');
    div.className = 'dropdown-item'+(selectedMetric&&m.key===selectedMetric.key?' active':'');
    div.textContent = m.label;
    div.onclick = () => {
      selectedMetric = m;
      document.getElementById('metric-label').textContent = m.label;
      document.getElementById('metric-label').style.color = '';
      document.getElementById('metric-box').classList.remove('placeholder');
      document.getElementById('metric-dropdown').style.display = 'none';
      document.querySelectorAll('#metric-list .dropdown-item').forEach(el =>
        el.classList.toggle('active', el.textContent===m.label));
      if (selectedGeoKey) renderContent();
    };
    list.appendChild(div);
  });
}

// ── Render ─────────────────────────────────────────────────────────────────
function renderContent() {
  if (!selectedMetric) return;
  const rows = (curData().get(selectedGeoKey)||[])
    .filter(r => r[selectedMetric.key]!==null && r[selectedMetric.key]!==undefined && r[selectedMetric.key]!=='');
  const chartData = rows.map(r => ({ date: formatDate(r.month_date_yyyymm), value: +r[selectedMetric.key] }));
  const displayName = curMap().get(selectedGeoKey) || selectedGeoKey;

  if (!chartData.length) {
    document.getElementById('main-layout').style.display = '';
    document.getElementById('empty-state-msg').style.display = 'none';
    document.getElementById('chart-panel').innerHTML =
      '<div class="empty-state" style="height:300px;display:flex;align-items:center;justify-content:center;">No data for <strong style="color:var(--text)">'+selectedMetric.label+'</strong> in '+displayName+'</div>';
    return;
  }

  const values = chartData.map(d=>d.value);
  const minVal = Math.min(...values), maxVal = Math.max(...values);
  const avgVal = values.reduce((a,b)=>a+b,0)/values.length;
  const latest = values[values.length-1];
  const colors = values.map(v => {
    if (maxVal===minVal) return '#38bdf8';
    const t = (v-minVal)/(maxVal-minVal);
    return 'rgb('+Math.round(30+t*26)+','+Math.round(77+t*112)+','+Math.round(107+t*141)+')';
  });
  const n = chartData.length;
  const tickStep = n>60 ? Math.floor(n/18) : n>24 ? 4 : 2;

  // Show layout, hide empty state
  document.getElementById('main-layout').style.display = '';
  document.getElementById('empty-state-msg').style.display = 'none';

  // Update chart panel
  document.getElementById('chart-panel').innerHTML =
    '<div class="chart-card">' +
      '<div class="chart-title">'+selectedMetric.label+'</div>' +
      '<div class="chart-subtitle">'+displayName+' · '+chartData.length+' months</div>' +
      '<div class="chart-wrap"><canvas id="main-chart"></canvas></div>' +
      '<div class="stats-row">' +
        '<div><div class="stat-label">LATEST</div><div class="stat-value">'+formatValue(latest,selectedMetric.format)+'</div></div>' +
        '<div><div class="stat-label">MIN</div><div class="stat-value">'+formatValue(minVal,selectedMetric.format)+'</div></div>' +
        '<div><div class="stat-label">MAX</div><div class="stat-value">'+formatValue(maxVal,selectedMetric.format)+'</div></div>' +
        '<div><div class="stat-label">AVG</div><div class="stat-value">'+formatValue(avgVal,selectedMetric.format)+'</div></div>' +
      '</div>' +
    '</div>';

  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  chartInstance = new Chart(document.getElementById('main-chart').getContext('2d'), {
    type: 'bar',
    data: { labels: chartData.map(d=>d.date), datasets: [{ data: values, backgroundColor: colors, borderRadius: 3, borderSkipped: false }] },
    options: {
      responsive: true, maintainAspectRatio: false, animation: { duration: 300 },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor:'#0f1117', borderColor:'#2a2d3a', borderWidth:1,
          titleColor:'#94a3b8', bodyColor:'#38bdf8',
          titleFont:{family:"'DM Mono',monospace",size:11},
          bodyFont:{family:"'DM Mono',monospace",size:13,weight:'500'},
          padding:10,
          callbacks:{ title:items=>items[0].label, label:item=>formatValue(item.raw,selectedMetric.format) }
        }
      },
      scales: {
        x: { grid:{display:false}, border:{color:'#2a2d3a'},
          ticks:{color:'#475569',font:{family:"'DM Mono',monospace",size:10},maxRotation:45,
            callback:function(val,i){return i%tickStep===0?this.getLabelForValue(val):'';}} },
        y: { grid:{color:'#1a1e2e'}, border:{display:false},
          ticks:{color:'#475569',font:{family:"'DM Mono',monospace",size:10},
            callback:v=>formatValue(v,selectedMetric.format)} }
      }
    }
  });
}


// ── Export ─────────────────────────────────────────────────────────────────
function getLatestRow() {
  const data = curData().get(selectedGeoKey) || [];
  // data is already sorted ascending, so last item is most recent
  return data[data.length - 1] || null;
}

function getLatestValues() {
  const row = getLatestRow();
  if (!row) return [];
  return METRICS.map(m => ({
    label: m.label,
    key: m.key,
    format: m.format,
    value: row[m.key] !== undefined && row[m.key] !== null && row[m.key] !== '' ? row[m.key] : null
  }));
}

function exportCSV() {
  const row = getLatestRow();
  const displayName = curMap().get(selectedGeoKey) || selectedGeoKey;
  const date = row ? formatDate(row.month_date_yyyymm) : '';
  const lines = ['Location,Date,Metric,Value,YY_Change'];
  REPORT_METRICS.forEach(m => {
    const val = (row && row[m.key] !== null && row[m.key] !== undefined && row[m.key] !== '') ? row[m.key] : '';
    const yval = (row && row[m.yy] !== null && row[m.yy] !== undefined && row[m.yy] !== '') ? row[m.yy] : '';
    lines.push(['"'+displayName+'"', date, '"'+m.label+'"', val, yval].join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (displayName + '_' + date + '_overview.csv').replace(/[^a-zA-Z0-9_-]/g,'_');
  a.click();
}

const REPORT_METRICS = [{"key": "median_listing_price", "label": "Median Listing Price", "format": "currency", "yy": "median_listing_price_yy"}, {"key": "active_listing_count", "label": "Active Listing Count", "format": "number", "yy": "active_listing_count_yy"}, {"key": "median_days_on_market", "label": "Days on Market", "format": "number", "yy": "median_days_on_market_yy"}, {"key": "new_listing_count", "label": "New Listing Count", "format": "number", "yy": "new_listing_count_yy"}, {"key": "price_increased_count", "label": "Price Increased Count", "format": "number", "yy": "price_increased_count_yy"}, {"key": "price_increased_share", "label": "Price Increased Share", "format": "percent", "yy": "price_increased_share_yy"}, {"key": "price_reduced_count", "label": "Price Reduced Count", "format": "number", "yy": "price_reduced_count_yy"}, {"key": "price_reduced_share", "label": "Price Reduced Share", "format": "percent", "yy": "price_reduced_share_yy"}, {"key": "pending_listing_count", "label": "Pending Listing Count", "format": "number", "yy": "pending_listing_count_yy"}, {"key": "median_listing_price_per_square_foot", "label": "Median Price Per Sq Ft", "format": "currency", "yy": "median_listing_price_per_square_foot_yy"}, {"key": "median_square_feet", "label": "Median Square Feet", "format": "number", "yy": "median_square_feet_yy"}, {"key": "average_listing_price", "label": "Average Listing Price", "format": "currency", "yy": "average_listing_price_yy"}, {"key": "total_listing_count", "label": "Total Listing Count", "format": "number", "yy": "total_listing_count_yy"}, {"key": "pending_ratio", "label": "Pending Ratio", "format": "decimal", "yy": "pending_ratio_yy"}];

function exportJPEG() {
  const row = getLatestRow();
  const displayName = curMap().get(selectedGeoKey) || selectedGeoKey;
  const date = row ? formatDate(row.month_date_yyyymm) : '';

  const cells = REPORT_METRICS.map(m => {
    const val = (row && row[m.key] !== null && row[m.key] !== undefined && row[m.key] !== '') ? row[m.key] : null;
    const yval = (row && row[m.yy] !== null && row[m.yy] !== undefined && row[m.yy] !== '') ? row[m.yy] : null;
    const formatted = val !== null ? formatValue(val, m.format) : 'N/A';
    const yyFormatted = yval !== null ? formatValue(yval, 'percent') : 'N/A';
    const yyColor = yval !== null ? (yval >= 0 ? '#4ade80' : '#f87171') : '#475569';
    return '<div class="sc-cell">' +
      '<div class="sc-cell-label">'+m.label+' (YY%)</div>' +
      '<div class="sc-cell-value">'+formatted+' <span style="font-size:13px;color:'+yyColor+';">('+yyFormatted+')</span></div>' +
    '</div>';
  }).join('');

  const card = document.getElementById('summary-card');
  card.innerHTML =
    '<div class="sc-header">' +
      '<div class="sc-title">'+displayName+'</div>' +
      '<div class="sc-sub">OVERVIEW REPORT &nbsp;&middot;&nbsp; REALTOR.COM INVENTORY DATA</div>' +
      '<div class="sc-date">MOST RECENT DATA: '+date+'</div>' +
    '</div>' +
    '<div class="sc-grid">'+cells+'</div>' +
    '<div class="sc-footer">Generated '+new Date().toUTCString()+' &nbsp;&middot;&nbsp; Source: Realtor.com Research Data</div>';

  card.style.left = '-9999px';
  card.style.display = 'block';

  html2canvas(card, {
    backgroundColor: '#080b12',
    scale: 2,
    useCORS: true,
    logging: false
  }).then(canvas => {
    card.style.display = 'none';
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/jpeg', 0.95);
    a.download = (displayName + '_' + date + '_overview.jpg').replace(/[^a-zA-Z0-9_-]/g,'_');
    a.click();
  });
}

// ── Boot ───────────────────────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', buildStateGrid);
</script>
</body>
</html>
